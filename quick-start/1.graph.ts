/**
 * ============================================================================
 * åŸºç¡€å›¾ç»“æ„ç¤ºä¾‹ - Basic Graph Example
 * ============================================================================
 *
 * ğŸ“– æ¦‚è¿°
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 * æœ¬æ–‡ä»¶æ¼”ç¤º LangGraph æœ€åŸºæœ¬çš„å›¾ç»“æ„ã€‚åŒ…æ‹¬çŠ¶æ€å®šä¹‰ã€èŠ‚ç‚¹åˆ›å»ºã€è¾¹è¿æ¥å’Œå›¾æ‰§è¡Œã€‚
 * è¿™æ˜¯å­¦ä¹  LangGraph çš„èµ·ç‚¹ï¼Œå±•ç¤ºäº†æ„å»ºå·¥ä½œæµçš„æ ¸å¿ƒæ¦‚å¿µã€‚
 *
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 * 1ï¸âƒ£ çŠ¶æ€å®šä¹‰ï¼šä½¿ç”¨ Annotation.Root å®šä¹‰å›¾çš„çŠ¶æ€ç»“æ„
 * 2ï¸âƒ£ èŠ‚ç‚¹å‡½æ•°ï¼šå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¥æ”¶çŠ¶æ€å¹¶è¿”å›æ›´æ–°
 * 3ï¸âƒ£ å›¾æ„å»ºï¼šä½¿ç”¨ StateGraph æ·»åŠ èŠ‚ç‚¹å’Œè¾¹
 * 4ï¸âƒ£ å›¾æ‰§è¡Œï¼šä½¿ç”¨ invoke æ–¹æ³•è¿è¡Œå›¾
 *
 * ğŸš€ ä½¿ç”¨æ–¹å¼
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 * $ npx esno quick-start/1.graph.ts
 *
 * ğŸ“¤ å¯¼å‡º
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 * â€¢ basicGraph - åŸºç¡€å›¾ç¤ºä¾‹ï¼Œå¯åœ¨ LangGraph Studio ä¸­è°ƒè¯•
 */

import './lib/loadEnv'
import { StateGraph, Annotation, START, END } from '@langchain/langgraph';

// ============================================================================
// 1ï¸âƒ£ çŠ¶æ€å®šä¹‰
// ============================================================================
// ä½¿ç”¨ Annotation.Root å®šä¹‰å›¾çš„çŠ¶æ€ç»“æ„
// æ¯ä¸ªå­—æ®µä½¿ç”¨ Annotation<T>() æŒ‡å®šç±»å‹
// çŠ¶æ€ä¼šåœ¨èŠ‚ç‚¹é—´ä¼ é€’ï¼ŒèŠ‚ç‚¹è¿”å›çš„æ›´æ–°ä¼šåˆå¹¶åˆ°çŠ¶æ€ä¸­
const StateAnnotation = Annotation.Root({
    input: Annotation<string>(),       // ç”¨æˆ·è¾“å…¥
    output: Annotation<string>(),      // å¤„ç†ç»“æœ
    step: Annotation<number>(),        // å½“å‰æ­¥éª¤
    isProcessed: Annotation<boolean>() // æ˜¯å¦å·²å¤„ç†
})

// ============================================================================
// 2ï¸âƒ£ èŠ‚ç‚¹å‡½æ•°å®šä¹‰
// ============================================================================
// èŠ‚ç‚¹å‡½æ•°æ¥æ”¶å½“å‰çŠ¶æ€ï¼Œè¿”å›è¦æ›´æ–°çš„å­—æ®µ
// è¿”å›çš„å¯¹è±¡ä¼šä¸ç°æœ‰çŠ¶æ€åˆå¹¶ï¼ˆæµ…åˆå¹¶ï¼‰

/**
 * è¾“å…¥å¤„ç†èŠ‚ç‚¹
 * - æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶è¿›è¡Œåˆæ­¥å¤„ç†
 * - è®¾ç½®æ­¥éª¤ä¸º 1ï¼Œæ ‡è®°ä¸ºå·²å¤„ç†
 */
const inputNode = (state: typeof StateAnnotation.State) => {
    console.log("%c Line:12 ğŸ­ state", "color:#6ec1c2", state.input);
    return {
        step: 1,
        output: `å¤„ç†åçš„æ•°æ®ï¼š${state.input}`,
        isProcessed: true
    }
}

/**
 * éªŒè¯èŠ‚ç‚¹
 * - å¯¹å¤„ç†ç»“æœè¿›è¡ŒéªŒè¯
 * - æ­¥éª¤ +1ï¼Œæ·»åŠ éªŒè¯æ ‡è®°
 */
const validateOutputNode = (state: typeof StateAnnotation.State) => {
    console.log("%c Line:22 ğŸ§€ state", "color:#f5ce50", state);
    return {
        step: state.step + 1,
        output: `${state.output}    [å·²éªŒè¯]`
    }
}

// ============================================================================
// 3ï¸âƒ£ æ„å»ºå›¾
// ============================================================================
// StateGraph: åˆ›å»ºå›¾å®ä¾‹ï¼Œä¼ å…¥çŠ¶æ€å®šä¹‰
// addNode: æ·»åŠ èŠ‚ç‚¹ï¼Œå‚æ•°ä¸º (èŠ‚ç‚¹å, èŠ‚ç‚¹å‡½æ•°)
// addEdge: æ·»åŠ è¾¹ï¼Œå®šä¹‰èŠ‚ç‚¹é—´çš„è¿æ¥å…³ç³»
// START/END: ç‰¹æ®ŠèŠ‚ç‚¹ï¼Œè¡¨ç¤ºå›¾çš„å…¥å£å’Œå‡ºå£
// compile: ç¼–è¯‘å›¾ï¼Œè¿”å›å¯æ‰§è¡Œçš„å›¾å®ä¾‹

// å¯¼å‡ºï¼šåŸºç¡€å›¾ç¤ºä¾‹
export const basicGraph = new StateGraph(StateAnnotation)
    .addNode('inputNode', inputNode)              // æ·»åŠ è¾“å…¥å¤„ç†èŠ‚ç‚¹
    .addNode('validateOutputNode', validateOutputNode)  // æ·»åŠ éªŒè¯èŠ‚ç‚¹
    .addEdge(START, 'inputNode')                  // START â†’ inputNode
    .addEdge('inputNode', 'validateOutputNode')   // inputNode â†’ validateOutputNode
    .addEdge('validateOutputNode', END)           // validateOutputNode â†’ END
    .compile()

// ============================================================================
// 4ï¸âƒ£ è¿è¡Œç¤ºä¾‹
// ============================================================================
async function runDemo() {
    // invoke: æ‰§è¡Œå›¾ï¼Œä¼ å…¥åˆå§‹çŠ¶æ€
    // è¿”å›æœ€ç»ˆçŠ¶æ€ï¼ˆåŒ…å«æ‰€æœ‰å­—æ®µçš„å®Œæ•´çŠ¶æ€ï¼‰
    const res = await basicGraph.invoke({ input: 'ä½ å¥½' })
    console.log("%c Line:39 ğŸ¥¤ res", "color:#42b983", res);
}

// è¿è¡Œç¤ºä¾‹
if (require.main === module) {
    runDemo()
}
